Type: "AWS::EC2::Instance"
Properties:
  AvailabilityZone: { "Fn::Select": ["0", { "Fn::GetAZs": { "Ref": "AWS::Region" } }] }
  LaunchTemplate:
    LaunchTemplateId: { "Ref": "LaunchTemplate" }
    Version: { "Fn::GetAtt" : [ "LaunchTemplate", "DefaultVersionNumber" ] }
  Tags:
    - Key: Name
      Value: Apache Kafka Kraft Instance
  UserData:
    Fn::Base64: !Sub 
    - |
      #!/bin/bash -xe
      exec > >(tee /var/log/user-data.log) 2>&1
      
      # Download and execute with error handling
      if ! curl -fSL https://raw.githubusercontent.com/teddynted/secure-apache-kafka-kraft-mode-using-sasl-scram-sha-256/refs/heads/main/shell-scripts/user-data.sh -o /tmp/user-data.sh; then
        echo "ERROR: Failed to download script"
        exit 1
      fi
      
      chmod +x /tmp/user-data.sh
      if ! /tmp/user-data.sh ${username} ${password} ${state} ${country} ${unit} ${city} ${nodeId}; then
        echo "ERROR: Script execution failed"
        exit 1
      fi
      
      echo "Installation completed successfully"
    - username: { "Fn::Sub": [ "${username}", { "username": "${env:SASL_SCRAM_USERNAME}" } ] }
      password: { "Fn::Sub": [ "${password}", { "password": "${env:SASL_SCRAM_PASSWORD}" } ] }
      state: { "Fn::Sub": [ "${state}", { "state": "${env:STATE}" } ] }
      country: { "Fn::Sub": [ "${country}", { "country": "${env:COUNTRY}" } ] }
      unit: { "Fn::Sub": [ "${unit}", { "unit": "${env:ORGANIZATION_UNIT}" } ] }
      city: { "Fn::Sub": [ "${city}", { "city": "${env:CITY}" } ] }
      nodeId: { "Fn::Sub": [ "${nodeId}", { "nodeId": 0 } ] }